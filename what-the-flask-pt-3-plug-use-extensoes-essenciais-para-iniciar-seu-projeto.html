<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PythonClub, ">
    <meta name="theme-color" content="#101212">

        <link rel="alternate"  href="http://pythonclub.com.br/feeds/all.atom.xml" type="application/atom+xml" title="PythonClub Full Atom Feed"/>
        <link rel="alternate" href="http://pythonclub.com.br/feeds/all.rss.xml" type="application/rss+xml" title="PythonClub Full RSS Feed"/>

    <link rel="shortcut icon" href="http://pythonclub.com.br/theme/images/favicon.ico" >

            <title>What the Flask? Pt-3 Plug & Use - extensões essenciais para iniciar seu projeto por Bruno Cezar Rocha // #PythonClub // </title>

    <meta property="fb:app_id" content="1487080281503641" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="What the Flask? Pt-3 Plug & Use - extensões essenciais para iniciar seu projeto" />
    <meta property="og:site_name" content="PythonClub" />
    <meta property="og:url" content="http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html" />
    <meta property="og:description" content="What The Flask - 3/5 Finalmente!!! A terceira parte da série What The Flask, mas ainda não acabou, serão 5 artigos para se tornar um Flasker, neste capítulo falaremos sobre como instalar e configurar as principais extensões do Flask para torna-lo uma solução full-stack com bootstrap no front-end, ORM para …" />
    <meta property="og:image" content="http://res.cloudinary.com/diu8g9l0s/image/upload/v1400201393/pythonclub/logo_275x130.png" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/pure.css">
    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/custom.css">

    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/pygments.css">



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50935105-1', 'pythonclub.com.br');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');

    </script>
    <!-- transifex -->
    <!-- <script type="text/javascript">  -->
    <!-- window.liveSettings = {  -->
    <!--     api_key: "f8fd260a9bdc4e9195c80e31416bb254",  -->
    <!--     picker: "bottom-right",  -->
    <!--     detectlang: true,  -->
    <!--     autocollect: true  -->
    <!-- };  -->
    <!-- </script>  -->
    <!-- <script type="text/javascript" src="//cdn.transifex.com/live.js"></script>  -->
    <!-- end transifex -->
    <meta name="google-site-verification" content="XQc_QtnTecI9nxAfplXGtECCpZQDwbDRcn7pyDVa1LE" />
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="http://pythonclub.com.br/author/bruno-cezar-rocha.html" title="See posts by Bruno Cezar Rocha">
                        <img class="article-avatar" alt="Bruno Cezar Rocha" src="https://www.gravatar.com/avatar/9200c133c210ad51e8005277e932061a">
                </a>
                <h2 class="article-info">Bruno Cezar Rocha</h2>
    			<ul class="author-social">
                    <li>
                        <a target="_blank" href="https://www.gittip.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-gittip"></i>
                            <strong>Gittip</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://github.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-github"></i>
                            <strong>Github</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://bitbucket.org/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-bitbucket"></i>
                            <strong>Bitbucket</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://twitter.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-twitter"></i>
                            <strong>Twitter</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="http://www.linkedin.com/in/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-linkedin"></i>
                            <strong>Linkedin</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="http://brunorocha.org">
                            <i class="fa fa-lg fa-fw fa-globe"></i>
                            <strong>Site</strong>
                        </a>
                    </li>
                </ul>
                <h5>Publicado em:</h5>
                <p>Wed 21 October 2015</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>What the Flask? Pt-3 Plug & Use - extensões essenciais para iniciar seu projeto</h1>
                        <p class="post-meta">
                            // Tags                                 <a class="post-category" href="http://pythonclub.com.br/tag/flask.html">flask</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/web.html">web</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/tutorial.html">tutorial</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/what-the-flask.html">what-the-flask</a>
                        </p>
                </header>
            </section>
            <h2>What The Flask - 3/5</h2>
<blockquote>
<p>Finalmente!!! A terceira parte da série <strong>What The Flask</strong>, mas ainda não acabou, serão 5 artigos para se tornar um <strong>Flasker</strong>, neste capítulo falaremos sobre como instalar e configurar as principais extensões do Flask para torna-lo uma solução full-stack com bootstrap no front-end, ORM para banco de dados, admin parecido com o Django Admin, Cache, Sistema de filas (celery/huey), Controle de Acesso, Envio de email, API REST e Login Social.</p>
</blockquote>
<figure style="float:left;margin-right:30px;width:35%">
<img src="/images/rochacbruno/lego_snake.jpg" alt="snake" >
<figcaption>Extending Flask</figcaption>
</figure>

<ol>
<li><a href="/what-the-flask-pt-1-introducao-ao-desenvolvimento-web-com-python.html"><strong>Hello Flask</strong></a>: Introdução ao desenvolvimento web com Flask</li>
<li><a href="/what-the-flask-pt-2-flask-patterns-boas-praticas-na-estrutura-de-aplicacoes-flask.html"><strong>Flask patterns</strong></a>: Estruturando aplicações Flask</li>
<li><a href="/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html"><strong>Plug &amp; Use</strong></a>: extensões essenciais para iniciar seu projeto(<strong>&lt;-- Você está aqui</strong>)</li>
<li><a href="/what-the-flask-pt-4-extensoes-para-o-flask.html"><strong>Magic(app)</strong></a>: Criando Extensões para o Flask</li>
<li><strong>Run Flask Run</strong>: "deploiando" seu app nos principais web servers e na nuvem</li>
</ol>
<p><br></p>
<blockquote>
<p><strong>Micro framework?</strong> Bom, o Flask foi criado com a premissa de ser um micro-framework, o que significa que ele não tem a intenção de entregar de bandeja para você todas as coisas que você precisa em único pacotinho e nem comandos mágicos que você roda e instantaneamente tem todo o seu projeto pronto. A idéia do Flask é ser pequeno e te dar o controle de tudo o que acontece no seu aplicativo, mas ao mesmo tempo o Flask se preocupa em ser facilmente extensivel, para isso os desenvolvedores pensaram em padrões que permitem que as extensões sejam instaladas de modo que não haja conflitos (lembra dos BluePrints do capítulo anterior?), além dos BluePrints tem também os patterns para desenvolvimento de extensions que ajuda a tornar a nossa vida mais fácil, nesta parte dessa série vamos instalar e configurar algumas das principais extensões do Flask (todas testadas por mim em projetos reais).</p>
</blockquote>
<h1>CMS de notícias</h1>
<p>Nesta série estamos desenvolvendo um mini CMS para publicação de notícias, o código está disponível no <a href="http://github.com/rochacbruno/wtf">github</a> e para cada fase da evolução do projeto tem uma branch diferente. Esse aplicativo de notícias tem os seguintes requisitos:</p>
<ul>
<li>Front-end usando o Bootstrap</li>
<li>Banco de dados MongoDB</li>
<li>Controle de acesso para que apenas editores autorizados publiquem notícias</li>
<li>Interface administrativa para as notícias e usuários</li>
<li>Cache das notícias para minimizar o acesso ao banco de dados</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> Existem várias extensões para Flask, algumas são aprovadas pelos desenvolvedores e entram para a lista disponível no site oficial, algumas entram para a listagem do metaflask (projeto em desenvolvimento), e uma grande parte está apenas no github. Como existem várias extensões que fazem a mesma coisa, as vezes é dificil escolher qual delas utilizar, eu irei mostrar aqui apenas as que eu utilizo e que já tenho experiência, mas isso não quer dizer que sejam as melhores, sinta-se a vontade para tentar com outras e incluir sua sugestão nos comentários.</p>
</blockquote>
<ul>
<li><a href="#bootstrap">Flask Bootstrap</a> - Para deixar as coisas bonitinhas</li>
<li><a href="#mongoengine">Flask MongoEngine</a> - Para armazenar os dados em um banco que é fácil fácil!</li>
<li><a href="#flask_security">Flask Security</a> - Controle de acesso</li>
<li><a href="#flask_admin">Flask-Admin</a> - Um admin tão poderoso quanto o Django Admin</li>
<li><a href="#flask_cache">Flask Cache</a> - Para deixar o MongoDB "de boas"</li>
<li>Bônus: Utilizaremos a Flask-DebugToolbar</li>
</ul>
<blockquote>
<p><strong>TL;DR:</strong> A versão final do app deste artigo esta no <a href="https://github.com/rochacbruno/wtf/tree/extended">github</a>, os apressados podem querer executar o app e explorar o seu código antes de ler o artigo completo.</p>
</blockquote>
<h2><a href="#bootstrap" name="bootstrap">Deixando as coisas bonitinhas com o Bootstrap!</a></h2>
<p>Atualmente a versão do nosso CMS está funcional porém bem feinha, não trabalhamos no design das páginas pois obviamente este não é o nosso objetivo, mas mesmo assim podemos deixar as coisas mais bonitinhas.</p>
<figure style="border:1px solid black;">
<img src="/images/rochacbruno/wtf_index.png" alt="wtf_index" >
<figcaption>Atual Layout do nosso CMS</figcaption>
</figure>

<p>Com a ajuda do Bootstrap e apenas uns ajustes básicos no front end podemos transformar o layout em algo muito mais apresentável.</p>
<p>Usaremos a extensão Flask-Bootstrap que traz alguns templates de base e utilidades para uso do Bootstrap no Flask.</p>
<p>Comece editando o arquivo de requirements adicionando <strong>Flask-Bootstrap</strong></p>
<p>Arquivo <strong>requirements.txt</strong></p>
<div class="highlight"><pre><span></span><span class="c">https://github.com/mitsuhiko/flask/tarball/master</span>
<span class="err">dataset</span>
<span class="err">nose</span>
<span class="err">Flask-Bootstrap</span>
</pre></div>


<p>Agora instale as dependencias em sua virtualenv.</p>
<div class="highlight"><pre><span></span>pip install -r requirements.txt --upgrade
</pre></div>


<p>Agora com o Flask-Bootstrap instalado basta iniciarmos a extensão durante a criação de nosso app.</p>
<p>Editando o arquivo <strong>news_app.py</strong> incluiremos:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="o">...</span>
    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Sendo que o arquivo completo ficaria:</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">.blueprints.noticias</span> <span class="kn">import</span> <span class="n">noticias_blueprint</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">instance_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_instance&quot;</span> <span class="o">%</span> <span class="n">mode</span>
    <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;wtf&quot;</span><span class="p">,</span>
                <span class="n">instance_path</span><span class="o">=</span><span class="n">instance_path</span><span class="p">,</span>
                <span class="n">instance_relative_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s1">&#39;wtf.default_settings&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s1">&#39;config.cfg&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_ROOT&#39;</span><span class="p">),</span>
        <span class="n">app</span><span class="o">.</span><span class="n">instance_path</span><span class="p">,</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_FOLDER&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">noticias_blueprint</span><span class="p">)</span>

    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>As extensões Flask seguem dois padrões de inicialização: Imediato e Lazy, é recomendado que toda extensão siga este protocolo.</p>
<p>Inicialização imediata:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_nome_da_extensao</span> <span class="kn">import</span> <span class="n">Extensao</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">Extensao</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>Da forma acima sempre importamos uma classe com o nome da extensao e então passamos o nosso <strong>app</strong> como parametro na inicialiação da extensão. Assim durante o init da extensão ela poderá injetar templates, modificar rotas e adicionar configs no app que foi passado como parametro.</p>
<p>Inicialização Lazy:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_nome_da_extensao</span> <span class="kn">import</span> <span class="n">Extensao</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">extensao</span> <span class="o">=</span> <span class="n">Extensao</span><span class="p">()</span>  <span class="c1"># note que não é passado nada como parametro!</span>


<span class="c1"># em qualquer momento no seu código</span>
<span class="n">Extensao</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>Geralmente o primeiro modo <strong>inicio imediato</strong> é o mais utilizado, o carregamento Lazy é útil em situações mais complexas como por exemplo se o seu sistema estiver esperando a conexão com um banco de dados.</p>
<blockquote>
<p>NOTE: Toda extensão do Flask deve começar com o nome <strong>flask_</strong> para ser considerada uma extensão dentro dos padrões.</p>
</blockquote>
<p>No nosso caso utilizamos <strong>Bootstrap(app)</strong> e agora o bootstrap já está disponível para ser utilizado em nossos templates!</p>
<h3>Customizando os templates com o BootStrap.</h3>
<p>Precisaremos efetuar algumas mudanças nos templates para que eles utilizem os estilos do Bootstrap 3.x</p>
<blockquote>
<p>Não entrarei em detalhes a respeito da estensão Flask-Bootstrap pois temos mais uma série de extensões para instalar, mas você pode consultar a <a href="https://pythonhosted.org/Flask-Bootstrap/basic-usage.html">documentação oficial</a> para saber mais a respeito dos blocos de template e utilidades disponíveis.</p>
</blockquote>
<h3>Comece alterando o template <strong>base.html</strong> para:</h3>
<div class="highlight"><pre><span></span>{%- extends &quot;bootstrap/base.html&quot; %}
{% import &quot;bootstrap/utils.html&quot; as utils %}
{% block title %} {{title or &quot;Notícias&quot;}} {% endblock %}
{% block navbar -%}
    <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar navbar-default&quot;</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-brand&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;static&#39;, filename=&#39;generic_logo.gif&#39;)}}&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;height:30px;&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nav navbar-nav&quot;</span><span class="p">&gt;</span>
         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;noticias.index&#39;)}}&quot;</span><span class="p">&gt;</span>HOME<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;noticias.cadastro&#39;)}}&quot;</span><span class="p">&gt;</span>CADASTRO<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
       <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
{%- endblock navbar %}

{% block content %}
 <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;jumbotron&quot;</span><span class="p">&gt;</span>
      {% block news %}
      {% endblock %}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{%- endblock content%}
</pre></div>


<p>Algumas coisas continuaram iguais ao template antigo, porém agora estamos utilizando blocos <strong>navbar</strong> e <strong>content</strong> definidos pelo Flask-Bootstrap e criamos um novo bloco <strong>news</strong> que usaremos para mostras as nossas notícias.</p>
<h3>Altere o template index.html</h3>
<div class="highlight"><pre><span></span>{% extends &quot;base.html&quot; %}
{% block news %}
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Todas as notícias<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
    {% for noticia in noticias %}
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;noticias.noticia&#39;, noticia_id=noticia.id)}}&quot;</span><span class="p">&gt;</span>
         {{noticia.titulo}}
        <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    {% endfor %}
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
{% endblock %}
</pre></div>


<p>apenas mudamos o nome do bloco utilizado de <strong>content</strong> para <strong>news</strong> e adicionamos um título.</p>
<h3>Altere o template noticia.html</h3>
<div class="highlight"><pre><span></span>{% extends &quot;base.html&quot; %}
{% block title%}
    {{noticia.titulo}}
{% endblock%}

{% block news %}
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{noticia.titulo}}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    {% if noticia.imagem %}
        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;noticias.media&#39;, filename=noticia.imagem) }}&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;300&quot;</span> <span class="p">/&gt;</span>
    {% endif %}
    <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        {{noticia.texto|safe}}
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
{% endblock %}
</pre></div>


<p>Novamente mudamos o bloco principal de <strong>content</strong> para <strong>news</strong></p>
<h3>Altere os templates cadastro.html e cadastro_sucesso.html</h3>
<p>Altere o bloco utilizado de <strong>content</strong> para <strong>news</strong> e o restante deixe como está por enquanto.</p>
<div class="highlight"><pre><span></span>{% extends &quot;base.html&quot; %}
{% block news %}
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;noticias.cadastro&#39;) }}&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Titulo:<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;titulo&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;titulo&quot;</span> <span class="p">/&gt;</span>
   <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
   <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Texto:<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;texto&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;texto&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
   <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span> Imagem:<span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;imagem&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;imagem&quot;</span> <span class="p">/&gt;</span>
   <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Postar&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
{% endblock %}
</pre></div>


<h3>Resultado Final!</h3>
<p>Antes do bootstrap</p>
<figure style="border:1px solid black;">
<img src="/images/rochacbruno/wtf_index.png" alt="wtf_index" >
</figure>

<p>e depois:</p>
<figure>
<img src="/images/rochacbruno/bootstrap.png" alt="wtf_index_bootstrap" >
</figure>

<blockquote>
<p>O diff com as mudanças que foram feitas pode ser acessado neste <a href="https://github.com/rochacbruno/wtf/commit/5645de0fb208fc9ee34e502d901c057c9a3f2445">link</a></p>
</blockquote>
<p>Agora que o app já está com uma cara mais bonita, vamos passar para o próximo requisito: Banco de Dados.</p>
<p>Até agora usamos o <strong>dataset</strong> que é uma mão na roda! integrando facilmente o nosso projeto com bancos como MySQL, Postgres ou SQLite.</p>
<p>Porém nosso site de notícias precisa utilizar <strong>MongoDB</strong> e para isso vamos recorrer ao <strong>Flask-MongoEngine</strong></p>
<h2><a href="#mongoengine" name="mongoengine"> Utilizando MongoDB com Flask</a></h2>
<figure style="float:left;margin-right:10px;">
<img src="/images/rochacbruno/mongo.jpg" alt="mongo" >
</figure>

<p>Vamos migrar do Dataset + SQlite para MongoDB e obviamente você irá precisar do MongoDb Server rodando, você pode preferir instalar o Mongo localmente se estiver em uma máquina Linux/Debian: <code>sudo apt-get install mongodb</code> ou siga instruções no site oficial do Mongo de acordo com seu sistema operacional.</p>
<p>Uma opção melhor é utilizar o <strong>docker</strong> para executar o MongoDB, desta forma você não precisa instalar o servidor de banco de dados em seu computador, precisa apenas do Docker e da imagem oficial do Mongo.</p>
<p>Vou mostrar os preocedimentos para instalação e execução no Linux/Debian, mas você pode tranquilamente utilizar outro S.O bastando seguir as instruções encontradas no site do docker.</p>
<h4>Instalando o docker</h4>
<p>No linux a maneira mais fácil de instalar o Docker é rodando o seguinte comando</p>
<div class="highlight"><pre><span></span><span class="err">wget -qO- https://get.docker.com/ | sh</span>
</pre></div>


<p>Se você precisar de ajuda ou estiver usando um sistema operacional alternativo pode seguir as <a href="http://docs.docker.com/linux/started/">instruções do site oficial</a></p>
<h4>Executando um container MongoDB</h4>
<p>No DockerHub está disponível a imagem oficial do Mongo, basta executar o comando abaixo para ter o Mongo rodando em um container.</p>
<div class="highlight"><pre><span></span><span class="err">docker run -d -v $PWD/mongodata:/data/db -p 27017:27017 mongo</span>
</pre></div>


<p>A parte do <code>$PWD/mongodata:</code> pode ser substituida pelo caminho de sua preferencia, este é o local onde o Mongo irá salvar os dados.</p>
<blockquote>
<p>Se preferir executar no modo efemero (perdendo todos os dados ao reiniciar o container) execute apenas <code>docker run -d -p 27017:27017 mongo</code></p>
</blockquote>
<h4>Instalando o MongoDB localmente (não recomendado, use o docker!)</h4>
<p>Você pode preferir não usar o Docker e instalar o Mongo localmente, <a href="https://www.mongodb.org/downloads">baixe o mongo</a> descompacte, abra um console separado e execute: <code>./bin/mongod --dbpath /tmp/</code> lembrando de trocar o <code>/tmp</code> por um diretório onde queira salvar seus dados.</p>
<p>Se preferir utilize os pacotes oficiais do seu sistema operacional para instalar o Mongo.</p>
<blockquote>
<p>IMPORTANTE: Para continuar você precisa ter uma instância do MongoDB rodando localmente, no Docker ou até mesmo em um servidor remoto se preferir.</p>
</blockquote>
<h2>Flask-Mongoengine</h2>
<p>Adicione a extensão Flask-Mongoengine ao seu arquivo requirements.txt</p>
<div class="highlight"><pre><span></span><span class="c">https://github.com/mitsuhiko/flask/tarball/master</span>
<span class="err">flask-mongoengine</span>
<span class="err">nose</span>
<span class="err">Flask-Bootstrap</span>
</pre></div>


<p>Agora execute <code>pip install -r requirements.txt --upgrade</code> estando na virtualenv de seu projeto.</p>
<h3>Substituindo o Dataset pelo MongoEngine</h3>
<p>Agora vamos substituir o <strong>dataset</strong> pelo <strong>MongoEngine</strong>, por padrão o MongoEngine tentará conectar no <strong>localhost</strong> na porta <strong>27017</strong> e utilizar o banco de dados <strong>test</strong>. Mas no nosso caso é essencial informarmos exatamente as configurações desejadas.</p>
<p>No arquivo de configuração em <code>development_instance/config.cfg</code> adicione as seguintes linhas:</p>
<div class="highlight"><pre><span></span><span class="n">MONGODB_DB</span> <span class="o">=</span> <span class="s2">&quot;noticias&quot;</span>
<span class="n">MONGODB_HOST</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>  <span class="c1"># substitua se utilizar um server remoto</span>
<span class="n">MONGODB_PORT</span> <span class="o">=</span> <span class="mi">27017</span>
</pre></div>


<p>Agora vamos ao arquivo <code>db.py</code> vamos definir a conexão com o banco de dados Mongo, apague todo o conteúdo do arquivo e substitua por:</p>
<p><strong>db.py</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">flask_mongoengine</span> <span class="kn">import</span> <span class="n">MongoEngine</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">MongoEngine</span><span class="p">()</span>
</pre></div>


<p>Crie um novo arquivo chamado <strong>models.py</strong>, é nesse arquivo que definiremos o esquema de dados nas nossas notícias. Note que o Mongo é um banco schemaless, poderiamos apenas criar um objeto <strong>Noticia(db.DynamicDocument)</strong> usando herança do DynamicDocument e isso tiraria a necessidade da definição do schema, porém, na maioria dos casos definir um schema básico ajuda a construir formulários e validar os dados.</p>
<p><strong>models.py</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">Noticia</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Document</span><span class="p">):</span>
    <span class="n">titulo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">()</span>
    <span class="n">texto</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">()</span>
    <span class="n">imagem</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">()</span>
</pre></div>


<p>Nosso próximo passo é alterar as views para que o armazenamento seja feito no MongoDB ao invés do SQLite.</p>
<p>No MongoEngine algumas operações serão um pouco diferente, alguns exemplos:</p>
<p><strong>Criar um novo registro de Noticia</strong></p>
<div class="highlight"><pre><span></span><span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">titulo</span><span class="o">=</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">texto</span><span class="o">=</span><span class="s1">&#39;World&#39;</span><span class="p">,</span> <span class="n">imagem</span><span class="o">=</span><span class="s1">&#39;caminho/imagem.png&#39;</span><span class="p">)</span>
</pre></div>


<p><strong>Buscar todas as Noticias</strong></p>
<div class="highlight"><pre><span></span><span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p><strong>Buscar uma noticia pelo id</strong></p>
<div class="highlight"><pre><span></span><span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>


<p>Altere <code>blueprints/noticias.py</code> para:</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">render_template</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Noticia</span>

<span class="n">noticias_blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;noticias&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/noticias/cadastro&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">cadastro</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">dados_do_formulario</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">imagem</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imagem&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imagem</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">imagem</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">imagem</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dados_do_formulario</span><span class="p">[</span><span class="s1">&#39;imagem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">nova_noticia</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">dados_do_formulario</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;cadastro_sucesso.html&#39;</span><span class="p">,</span>
                               <span class="n">id_nova_noticia</span><span class="o">=</span><span class="n">nova_noticia</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;cadastro.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Inserir nova noticia&quot;</span><span class="p">)</span>


<span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">todas_as_noticias</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
                           <span class="n">noticias</span><span class="o">=</span><span class="n">todas_as_noticias</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Todas as notícias&quot;</span><span class="p">)</span>


<span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/noticia/&lt;noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">):</span>
    <span class="n">noticia</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;noticia.html&#39;</span><span class="p">,</span> <span class="n">noticia</span><span class="o">=</span><span class="n">noticia</span><span class="p">)</span>


<span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/media/&lt;path:filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">media</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>


<p>Lembre-se que nós ainda não conectamos ao Mongo Server apenas definimos como será a conexão, então precisaremos agora usar o método lazy de inicialização de extensões chamando o <code>init_app()</code> do MongoEngine.</p>
<p>No arquivo <code>news_app.py</code> adicione as seguintes linhas.</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">db</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Sendo que o arquivo final será:</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">.blueprints.noticias</span> <span class="kn">import</span> <span class="n">noticias_blueprint</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">db</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">instance_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_instance&quot;</span> <span class="o">%</span> <span class="n">mode</span>
    <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;wtf&quot;</span><span class="p">,</span>
                <span class="n">instance_path</span><span class="o">=</span><span class="n">instance_path</span><span class="p">,</span>
                <span class="n">instance_relative_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s1">&#39;wtf.default_settings&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s1">&#39;config.cfg&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_ROOT&#39;</span><span class="p">),</span>
        <span class="n">app</span><span class="o">.</span><span class="n">instance_path</span><span class="p">,</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_FOLDER&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">noticias_blueprint</span><span class="p">)</span>

    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Execute o programa</p>
<div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">run</span><span class="o">.</span><span class="n">py</span>
</pre></div>


<p>E veja se consegue inserir algumas noticias acessando <a href="http://localhost:5000">http://localhost:5000</a></p>
<p>Para explorar os dados do MongoDB visualmente você pode utilizar o RoboMongo.</p>
<figure>
<img src="/images/rochacbruno/robomongo.png" alt="wtf_robomongo" >
</figure>

<blockquote>
<p>O Diff das alterações que fizemos relativas ao Flask-MongoEngine podem ser comparadas nos seguintes commits <a href="https://github.com/rochacbruno/wtf/commit/88effa01b5ffd11f3fd7d5530f90591e421dd109">88effa01b5ffd11f3fd7d5530f90591e421dd109</a> e <a href="https://github.com/rochacbruno/wtf/commit/189f4d4d2c8af845ccc0b181e4f6a1831578fbfa">189f4d4d2c8af845ccc0b181e4f6a1831578fbfa</a></p>
</blockquote>
<h2><a href="#flask_security" name="flask_security">Controle de acesso com o Flask Security</a></h2>
<figure style="float:left;margin-right:10px;width:25%;">
<img src="/images/rochacbruno/security.jpg" alt="security" >
</figure>

<p>Nosso CMS de notícias está inseguro, ou seja, qualquer um que acessar a url <a href="http://localhost:5000/noticias/cadastro">http://localhost:5000/noticias/cadastro</a> vai conseguir adicionar uma nova notícia sem precisar efetuar login.</p>
<p>Para resolver este tipo de problema existe a extensão Flask-Login que oferece métodos auxiliares para autenticar usuários e também a Flask-Security é um pacote feito em cima do Flask-Login (controle de autenticação), Flask-Principal (Controle de Permissões) e Flask-Mail (envio de email).</p>
<p>A vantagem de usar o Flask-Security é que ele já se integra com o MongoEngine e oferece templates prontos para login, alterar senha, envio de email de confirmação etc...</p>
<p>Começaremos adicionando a dependencia ao arquivo de requirements.</p>
<p><strong>requirements.txt</strong></p>
<div class="highlight"><pre><span></span><span class="c">https://github.com/mitsuhiko/flask/tarball/master</span>
<span class="err">flask-mongoengine</span>
<span class="err">nose</span>
<span class="err">Flask-Bootstrap</span>
<span class="err">Flask-Security</span>
</pre></div>


<p>E então instalamos com <code>pip install -r requirements.txt --upgrade</code></p>
<h3>Secret Key</h3>
<p>Para encriptar os passwords dos usuários o Flask-Login irá utilizar a chave secret key do settings de seu projeto. É muito importante que esta chave seja segura e gerada de maneira randomica (utilize uuid4 ou outro método de geração de chaves).</p>
<p>Para testes e desenvolvimento você pode utilizar texto puro. <strong>mas em produção escolha uma chave segura!</strong></p>
<p>Além disso o Flask-Security precisa que seja especificado qual tipo de hash usar nos passwords.</p>
<p>Adicione ao <code>development_instance/config.cfg</code></p>
<div class="highlight"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">&#39;super-secret&#39;</span>
<span class="n">SECURITY_PASSWORD_HASH</span> <span class="o">=</span> <span class="s1">&#39;pbkdf2_sha512&#39;</span>
<span class="n">SECURITY_PASSWORD_SALT</span> <span class="o">=</span> <span class="n">SECRET_KEY</span>
</pre></div>


<blockquote>
<p>Importante se esta chave for perdida todas as senhas armazenadas serão invalidadas.</p>
</blockquote>
<h3>Definindo o schema dos usuários e grupos</h3>
<p>O Flask-Security permite o controle de acesso utilizando RBAC (Role Based Access Control), ou seja, usuários pertencem a grupos e os acessos são concedidos aos grupos.</p>
<p>Para isso precisamos armazenar (no nosso caso no MongoDB) os usuários e seus grupos.</p>
<p>Crie um novo arquivo <strong>security_models.py</strong> e criaremos duas classes <strong>User</strong> e <strong>Role</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">UserMixin</span><span class="p">,</span> <span class="n">RoleMixin</span>
<span class="kn">from</span> <span class="nn">flask_security.utils</span> <span class="kn">import</span> <span class="n">encrypt_password</span>


<span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Document</span><span class="p">,</span> <span class="n">RoleMixin</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">createrole</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Document</span><span class="p">,</span> <span class="n">UserMixin</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">confirmed_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ListField</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ReferenceField</span><span class="p">(</span><span class="n">Role</span><span class="p">,</span> <span class="n">reverse_delete_rule</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">DENY</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">last_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">current_login_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">last_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">current_login_ip</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">IntField</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">createuser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                   <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">encrypt_password</span><span class="p">(</span><span class="n">password</span><span class="p">),</span>
            <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">,</span>
            <span class="n">roles</span><span class="o">=</span><span class="n">roles</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
</pre></div>


<p>O arquivo acima define os models com todas as propriedades necessárias para que o Flask-Security funcione com o MongoEngine, não entrerei em detalhes de cada campo pois usaremos somente o básico neste tutorial, acesse a documentação do Flask-Security se desejar saber mais a respeitod e cada atributo.</p>
<h3>Inicializando o Flask Security em seu projeto</h3>
<p>Da mesma forma que fizemos com as outras extensões iremos fazer como security, alterando o arquivo <strong>news_app.py</strong> e inicializando a extensão utilizando o método default.</p>
<p>Importaremos o <strong>Security</strong> e o <strong>MongoEngineUserDatastore</strong> e inicializaremos a extensão passando nossos models de User e Role.</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">Security</span><span class="p">,</span> <span class="n">MongoEngineUserDatastore</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.security_models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
   <span class="o">...</span>
   <span class="n">Security</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">datastore</span><span class="o">=</span><span class="n">MongoEngineUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">))</span>
   <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p><strong>news_app.py</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">Security</span><span class="p">,</span> <span class="n">MongoEngineUserDatastore</span>

<span class="kn">from</span> <span class="nn">.blueprints.noticias</span> <span class="kn">import</span> <span class="n">noticias_blueprint</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.security_models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">instance_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_instance&quot;</span> <span class="o">%</span> <span class="n">mode</span>
    <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;wtf&quot;</span><span class="p">,</span>
                <span class="n">instance_path</span><span class="o">=</span><span class="n">instance_path</span><span class="p">,</span>
                <span class="n">instance_relative_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s1">&#39;wtf.default_settings&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s1">&#39;config.cfg&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_ROOT&#39;</span><span class="p">),</span>
        <span class="n">app</span><span class="o">.</span><span class="n">instance_path</span><span class="p">,</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_FOLDER&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">noticias_blueprint</span><span class="p">)</span>

    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">Security</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">datastore</span><span class="o">=</span><span class="n">MongoEngineUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Pronto, agora temos nossa base de usuários e grupos definida e o Security irá iniciar em nosso app todo o restante necessário para o controle de login (session, cookies, formulários etc..)</p>
<h4>Exigindo login para cadastro de notícia</h4>
<p>Altere a view de cadastro em <code>blueprints/noticias.py</code> e utilize o decorator <code>login_required</code> que é disponibilizado pelo Flask-Security, sendo que o inicio do arquivo ficará assim:</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">render_template</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Noticia</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">login_required</span>  <span class="c1"># decorator</span>

<span class="n">noticias_blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;noticias&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/noticias/cadastro&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@login_required</span>  <span class="c1"># aqui o login será verificado</span>
<span class="k">def</span> <span class="nf">cadastro</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>


<p>Execute <code>python run.py</code> acesse <a href="http://localhost:5000/noticias/cadastro">http://localhost:5000/noticias/cadastro</a> e verifique que o login será exigido para continuar.</p>
<blockquote>
<p>NOTE: Se por acaso ocorrer um erro <strong>TypeError: 'bool' object is not callable</strong> execute o seguinte comando <code>pip install Flask-Login==0.2.11</code> e adicione  <code>Flask-Login==0.2.11</code> no arquivo requirements.txt. Este erro ocorre por causa de um recente bug na nova versão do Flask-Login.</p>
</blockquote>
<p>Se tudo ocorrer como esperado agora você será encaminhado para a página de login.</p>
<figure>
<img src="/images/rochacbruno/login.png" alt="login" >
</figure>

<p>O único problema é que você ainda não possui um usuário para efetuar o login. Em nosso model de User definimos um método <strong>create_user</strong> que pode ser utilizado diretamente em um terminal iPython. Porém o Flask-Security facilita bastante fornecendo também um formulário de registro de usuários.</p>
<p>Adicione as seguintes configurações no arquivo <code>development_instance/config.cfg</code> para habilitar o formulário de registro de usuários.</p>
<div class="highlight"><pre><span></span><span class="n">SECURITY_REGISTERABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SECURITY_TRACKABLE</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># para armazenar data, IP, ultimo login dos users.</span>

<span class="c1"># as opções abaixo devem ser removidas em ambiente de produção</span>
<span class="n">SECURITY_SEND_REGISTER_EMAIL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">SECURITY_LOGIN_WITHOUT_CONFIRMATION</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SECURITY_CHANGEABLE</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>


<p>Agora acesse <a href="http://localhost:5000/register">http://localhost:5000/register</a> e você poderá registar um novo usuário e depois efetuar login.</p>
<figure>
<img src="/images/rochacbruno/register.png" alt="register" >
</figure>

<blockquote>
<p>NOTE: É recomendado que a opção de registro de usuário seja desabilidata em ambiente de produção, que seja utilizado outros meios como o Flask-Admin que veremos adiante para registrar novos usuários ou que seja habilitado o Captcha para os formulários de registro e login e também o envio de email de confirmação de cadastro.</p>
</blockquote>
<p>Todas as opções de configuração do Flsk-Security estão disponíveis em <a href="https://pythonhosted.org/Flask-Security/configuration.html">https://pythonhosted.org/Flask-Security/configuration.html</a></p>
<p>Agora será interessante mostrar opções de Login, Logout, Alterar senha na barra de navegação. Para isso altere o template <code>base.html</code> adicionando o bloco de access control.</p>
<div class="highlight"><pre><span></span>{%- extends &quot;bootstrap/base.html&quot; %}
{% import &quot;bootstrap/utils.html&quot; as utils %}
{% block title %} {{title or &quot;Notícias&quot;}} {% endblock %}
{% block navbar -%}
    <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar navbar-default&quot;</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-brand&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;static&#39;, filename=&#39;generic_logo.gif&#39;)}}&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;height:30px;&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nav navbar-nav&quot;</span><span class="p">&gt;</span>
         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;noticias.index&#39;)}}&quot;</span><span class="p">&gt;</span>HOME<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for(&#39;noticias.cadastro&#39;)}}&quot;</span><span class="p">&gt;</span>CADASTRO<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
         {% block access_control %}
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;divider-vertical&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            {% if current_user.is_authenticated() %}
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&quot;dropdown&quot;</span><span class="p">&gt;</span>
                 {{current_user.email}}  <span class="p">&lt;</span><span class="nt">b</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;caret&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for_security(&#39;change_password&#39;)}}&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-user&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> Change password<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for_security(&#39;logout&#39;)}}&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-off&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            {% else %}
              <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for_security(&#39;login&#39;)}}&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;icon-off&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> Login<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            {% endif %}
        {% endblock %}
       <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
{%- endblock navbar %}
{% block content %}
 <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
  {%- with messages = get_flashed_messages(with_categories=True) %}
  {%- if messages %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-12&quot;</span><span class="p">&gt;</span>
        {{utils.flashed_messages(messages)}}
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  {%- endif %}
  {%- endwith %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;jumbotron&quot;</span><span class="p">&gt;</span>
      {% block news %}
      {% endblock %}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{%- endblock content%}
</pre></div>


<p>O resultado final será:</p>
<figure>
<img src="/images/rochacbruno/access.png" alt="access" >
</figure>

<p>As opções de customização e instruções de como alterar os formulários e templates do Flask-Security encontram-se na <a href="https://pythonhosted.org/Flask-Security/">documentação oficial</a>.</p>
<blockquote>
<p>O diff com todas as alterações feitas com o Flask-Security pode ser consultado neste <a href="https://github.com/rochacbruno/wtf/commit/3766bfabb6d9c359731ff3a143101209af0d207f">link</a></p>
</blockquote>
<h2><a href="#flask_admin" name="flask_admin">Flask Admin - Um admin tão poderoso quanto o Django Admin!</a></h2>
<figure>
<img src="/images/rochacbruno/admin.jpg" alt="admin" >
</figure>

<p>Todos sabemos que uma das grandes vantagens de um framework full-stack como Django ou Web2py é a presença de um Admin para o banco de dados. Mesmo sendo Micro-Framework o Flask conta com a extensão Flask-Admin que o transforma em uma solução tão completa quanto o Django-Admin.</p>
<p>O Flask-Admin é uma das mais importantes extensões para o Flask e é frequentemente atualizada e tem uma comunidade muito ativa! O AirBnb recentemente lançou o <a href="http://mrjoes.github.io/2015/06/17/flask-admin-120.html">AirFlow que utiliza o Flask-Admin</a></p>
<p>E o <a href="http://www.quokkaproject.org">QuokkaCMS</a>, principal CMS desenvolvido com Flask e MongoDB é baseado também no Flask-Admin.</p>
<p>Para começar vamos colocar os requisitos no arquivo de requirements!!</p>
<p><strong>requirements.txt</strong></p>
<div class="highlight"><pre><span></span><span class="c">https://github.com/mitsuhiko/flask/tarball/master</span>
<span class="err">flask-mongoengine</span>
<span class="err">nose</span>
<span class="err">Flask-Bootstrap</span>
<span class="err">Flask-Security</span>
<span class="err">Flask-Login==0.2.11</span>
<span class="err">Flask-Admin</span>
</pre></div>


<p>Instalar com <code>pip install -r requirements.txt --upgrade</code></p>
<h3>Admin para o seu banco de dados MongoDB!!!</h3>
<p>O Flask-Admin é um painel administrativo para bancos de dados de seus projetos Flask e ele tem suporte a diversos ORMs e Tecnologias como MySQL, PostGres, SQLServer e ORMs SQLAlchemy, Peewee, PyMongo e MongoEngine.</p>
<p>O Flask Admin utiliza o Bootstrap por padrão para a camada visual do admin, mas é possivel customizar com o uso de temas.</p>
<p>A primeira coisa a ser feita depois de ter o Flask-Admin instalado é inicializar o admin da mesma maneira que fizemos com as outras extensões.</p>
<p>Vamos adicionar as seguintes linhas ao arquivo <strong>news_app.py</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_admin</span> <span class="kn">import</span> <span class="n">Admin</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
   <span class="o">...</span>
   <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Noticias&#39;</span><span class="p">,</span> <span class="n">template_mode</span><span class="o">=</span><span class="s1">&#39;bootstrap3&#39;</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Ficando o arquivo completo.</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">Security</span><span class="p">,</span> <span class="n">MongoEngineUserDatastore</span>
<span class="kn">from</span> <span class="nn">flask_admin</span> <span class="kn">import</span> <span class="n">Admin</span>

<span class="kn">from</span> <span class="nn">.blueprints.noticias</span> <span class="kn">import</span> <span class="n">noticias_blueprint</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.security_models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">instance_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_instance&quot;</span> <span class="o">%</span> <span class="n">mode</span>
    <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;wtf&quot;</span><span class="p">,</span>
                <span class="n">instance_path</span><span class="o">=</span><span class="n">instance_path</span><span class="p">,</span>
                <span class="n">instance_relative_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s1">&#39;wtf.default_settings&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s1">&#39;config.cfg&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_ROOT&#39;</span><span class="p">),</span>
        <span class="n">app</span><span class="o">.</span><span class="n">instance_path</span><span class="p">,</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_FOLDER&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">noticias_blueprint</span><span class="p">)</span>

    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">Security</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">datastore</span><span class="o">=</span><span class="n">MongoEngineUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">))</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Noticias&#39;</span><span class="p">,</span> <span class="n">template_mode</span><span class="o">=</span><span class="s1">&#39;bootstrap3&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Agora basta executar <code>python run.py</code> e acessar <a href="http://localhost:5000/admin/">http://localhost:5000/admin/</a> e você verá a tela <strong>index</strong> do Flask-Admin.</p>
<figure>
<img src="/images/rochacbruno/admin_index.png" alt="admin_index" >
</figure>

<p>Se você conseguir acessar a tela acima então o Flask-Admin está inicializado corretamente, perceba que não tem nada além de uma tela em branco e um botão "home".</p>
<p>Precisamos agora registrar nossas ModelViews que são as telas de administração para cada coleção ou tabela do banco de dados e também implementar a integração com o Flask-Security para garantir que somente pessoas autorizadas acessem o admin.</p>
<h4>Menu de controle de acesso</h4>
<p>Em nosso front-end incluimos na barra de menus os links de controle de acesso <strong>login</strong>, <strong>alterar senha</strong> e <strong>logout</strong>, precisamos agora incluir os mesmos itens na barra de menus do Flask-Admin.</p>
<p>Para começar crie um template novo em <strong>templates/admin_base.html</strong> com o seguinte conteúdo.</p>
<div class="highlight"><pre><span></span>{% extends &#39;admin/base.html&#39; %}

{% block access_control %}
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-text btn-group pull-right&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&quot;dropdown&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">aria-expanded</span><span class="o">=</span><span class="s">&quot;false&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;glyphicon glyphicon-user&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
    {% if current_user.is_authenticated() %}
        {% if current_user.name -%}
            {{ current_user.name }}
        {% else -%}
            {{ current_user.email }}
        {%- endif %}
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;caret&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown-menu&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;menu&quot;</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for_security(&#39;logout&#39;)}}&quot;</span><span class="p">&gt;</span>Log out<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    {% else %}
       Access
       <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;caret&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
       <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dropdown-menu&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;menu&quot;</span><span class="p">&gt;</span>
           <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{url_for_security(&#39;login&#39;)}}&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    {% endif %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{% endblock %}
</pre></div>


<p>Agora altere o template base do Flask-Admin incluindo o parametro <code>base_template='admin_base.html'</code> no <strong>news_app.py</strong></p>
<div class="highlight"><pre><span></span><span class="err">def create_app(mode):</span>
<span class="err">    ...</span>
<span class="err">    admin = Admin(app, name=&#39;Noticias&#39;, template_mode=&#39;bootstrap3&#39;,</span>
<span class="err">                  base_template=&#39;admin_base.html&#39;)</span>
<span class="err">    return app</span>
</pre></div>


<figure>
<img src="/images/rochacbruno/admin_index_login.png" alt="admin_index_login" >
</figure>

<p>O Flask-Admin não possui uma forma automática de integração com o Flask-Security, porém podemos facilmente sobrescrever a classe de ModelView incluindo o controle de acesso necessário.</p>
<p>Para que isso fique mais fácil vamos centralizar a configuração do Flask-Admin em um único arquivo.</p>
<p>Crie um arquivo chamado <strong>wtf/admin.py</strong> na raiz do projeto, iremos extender a ModelView do Flask-Admin tornando-a segura e exigindo login e também iremos registrar os models <strong>Noticia</strong>, <strong>User</strong> e <strong>Role</strong> em nosso painel de adminsitração.</p>
<blockquote>
<p>NOTE: Se desejar que apenas usuários que pertençam ao grupo <strong>admin</strong> tenham acesso descomente as linhas do método <strong>is_acessible</strong></p>
</blockquote>
<p><strong>wtf/admin.py</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">flask_admin.contrib.mongoengine</span> <span class="kn">import</span> <span class="n">ModelView</span>
<span class="kn">from</span> <span class="nn">flask_admin</span> <span class="kn">import</span> <span class="n">Admin</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Noticia</span>
<span class="kn">from</span> <span class="nn">.security_models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>


<span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Noticias&#39;</span><span class="p">,</span> <span class="n">template_mode</span><span class="o">=</span><span class="s1">&#39;bootstrap3&#39;</span><span class="p">,</span>
              <span class="n">base_template</span><span class="o">=</span><span class="s1">&#39;admin_base.html&#39;</span><span class="p">)</span>


<span class="c1"># Create customized model view class</span>
<span class="k">class</span> <span class="nc">SafeModelView</span><span class="p">(</span><span class="n">ModelView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">is_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># if not current_user.has_role(&#39;admin&#39;):</span>
        <span class="c1">#     return False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_handle_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redireciona o usuário para página de login ou de acesso negado</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_accessible</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>  <span class="c1"># negado, caso não pertença ao grupo admin.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;security.login&#39;</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">configure_admin</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">SafeModelView</span><span class="p">(</span><span class="n">Noticia</span><span class="p">))</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">SafeModelView</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;accounts&#39;</span><span class="p">))</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">SafeModelView</span><span class="p">(</span><span class="n">Role</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;accounts&#39;</span><span class="p">))</span>
</pre></div>


<p>Agora só precisamos substituir a maneira como inicializamos o admin pela chamada a função <strong>configure_admin</strong>.</p>
<p>No arquivo <strong>news_app.py</strong> troque a parte</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_admin</span> <span class="kn">import</span> <span class="n">Admin</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Noticias&#39;</span><span class="p">,</span> <span class="n">template_mode</span><span class="o">=</span><span class="s1">&#39;bootstrap3&#39;</span><span class="p">,</span>
                  <span class="n">base_template</span><span class="o">=</span><span class="s1">&#39;admin_base.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Pelo uso da função <strong>configure_admin</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.admin</span> <span class="kn">import</span> <span class="n">configure_admin</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">configure_admin</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Desta forma ao executar <code>python run.py</code> e acessar <a href="http://localhost:5000/admin/">http://localhost:5000/admin/</a> estando logado você irá os menus referentes aos nossos models e poderá editar/apagar/adicionar novos usuários e notícias.</p>
<figure>
<img src="/images/rochacbruno/admin_noticia.png" alt="admin_noticia" >
</figure>

<p>O Flask-admin possui diversas opções de customização de template, formulários, permissões. Você pode limitar quais campos exibir, alterar o comportamento dos formulários e até mesmo incluir views e formulários que não estejam no banco de dados.</p>
<h3>Limitando os campos a serem exibidos.</h3>
<p>Atualmente clicando no menu <strong>accounts/user</strong> a lista exibe vários campos referentes ao cadastro de usuários (incluindo a senha encriptada).</p>
<figure>
<img src="/images/rochacbruno/admin_user_full.png" alt="admin_user_full" >
</figure>

<p>Altere nosso arquivo <strong>admin.py</strong> e crie uma nova classe <strong>UserModelView</strong> onde limitaremos os campos que serão listados no admin.</p>
<p><strong>wtf/admin.py</strong></p>
<div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span> <span class="nc">UserModelView</span><span class="p">(</span><span class="n">SafeModelView</span><span class="p">):</span>
    <span class="n">column_list</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;last_login_at&quot;</span><span class="p">,</span> <span class="s2">&quot;login_count&quot;</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>


<p>E agora no final do arquivo utilize esta classe ao adicionar a view.</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">UserModelView</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;accounts&#39;</span><span class="p">))</span>
<span class="o">...</span>
</pre></div>


<blockquote>
<p>NOTE: Não iremos nos aprofundar em todas as opções de customização do Flask-admin, portanto consulte a <a href="https://flask-admin.readthedocs.org/">documentação</a> para saber mais.</p>
</blockquote>
<figure>
<img src="/images/rochacbruno/admin_user_columns.png" alt="admin_user_columns" >
</figure>

<blockquote>
<p>O diff com todas as alterações referentes ao Flask-Admin estão no commit <a href="https://github.com/rochacbruno/wtf/commit/1359c4cf9a31a0d471a3226a1bec2a672f9ffbbb">1359c4cf9a31a0d471a3226a1bec2a672f9ffbbb</a></p>
</blockquote>
<h2><a href="#flask_cache" name="flask_cache">Flask Cache - Deixando o MongoDB "de boas"</a></h2>
<p>A cada vez que acessamos a home do nosso site uma consulta é feita ao MongoDB, e isso está definido em <strong>blueprints/noticias.py</strong></p>
<div class="highlight"><pre><span></span><span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">todas_as_noticias</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
                           <span class="n">noticias</span><span class="o">=</span><span class="n">todas_as_noticias</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Todas as notícias&quot;</span><span class="p">)</span>
</pre></div>


<p>Na linha <code>todas_as_noticias = Noticia.objects.all()</code> fazemos uma query ao MongoDB, se 10.000 usuários acessarem a nossa página 10.000 acessos serão feitos ao MongoDB.</p>
<p>O mesmo acontece na view de acesso a uma notícia <code>noticia = Noticia.objects.get(id=noticia_id)</code> vai até o MongoDB e faz a query procurando a notícia pelo <strong>id</strong> e teremos novamente problemas se por exemplo muitos usuários acessarem a mesma notícia ao mesmo tempo.</p>
<p>Podemos otimizar as queries no Mongo utilizando <strong>indices</strong> porém o mais indicado é o uso de cache.</p>
<figure style="float:left;margin-right:10px;width:30%;">
<img src="/images/rochacbruno/deboas.jpg" alt="deboas" >
</figure>

<p>Em ambiente de alta disponibilidade é altamente recomendado usar um servidor de cache como o <strong>Varnish</strong> para servir de camada intermediária ou até mesmo gerar páginas HTML estáticas de cada uma das notícias.</p>
<p>Mas em caso de sites menores podermos contar com um sistema de cache mais simples utilizando MemCached, Redis ou até mesmo sistema de arquivos para armazenar o cache.</p>
<p>Em nosso projeto usaremos o Flask-Cache que poderá ser usado com Redis ou da maneira simples utilizando o sistema de arquivos.</p>
<h3>Debug Toolbar</h3>
<p>Antes de mais nada precisamos de uma ajuda para enxergarmos o problema, vamos utilizar a Flask-DebugToolbar para nos mostrar o custo de nossas idas ao banco de dados e outras coisas uteis para o desenvolvimento em Flask.</p>
<p>Adicione ao arquivo <strong>requirements.txt</strong> a <strong>flask-debugtoolbar</strong> e utilize o flask-mongoengine diretamente do github.</p>
<div class="highlight"><pre><span></span><span class="c">https://github.com/mitsuhiko/flask/tarball/master</span>
<span class="c">https://github.com/MongoEngine/flask-mongoengine/tarball/master</span>
<span class="err">nose</span>
<span class="err">Flask-Bootstrap</span>
<span class="err">Flask-Security</span>
<span class="err">Flask-Login==0.2.11</span>
<span class="err">Flask-Admin</span>
<span class="err">flask-debugtoolbar</span>
<span class="err">flask-cache</span>
</pre></div>


<blockquote>
<p>NOTE: usaremos o flask-mongoengine diretamente do github <strong>https://github.com/MongoEngine/flask-mongoengine/tarball/master</strong> pois a versão do PyPI ainda não está compatível com a debug-toolbar</p>
</blockquote>
<p>E atualize sua <strong>env</strong> <code>pip install -r requirements.txt --upgrade</code></p>
<p>Agora edite o arquivo <strong>development_instance/config.cfg</strong> adicionando as seguintes entradas.</p>
<p><strong>development_instance/config.cfg</strong></p>
<div class="highlight"><pre><span></span><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DEBUG_TOOLBAR_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DEBUG_TB_INTERCEPT_REDIRECTS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DEBUG_TB_PROFILER_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DEBUG_TB_TEMPLATE_EDITOR_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DEBUG_TB_PANELS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.versions.VersionDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.timer.TimerDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.headers.HeaderDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.request_vars.RequestVarsDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.template.TemplateDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_mongoengine.panels.MongoDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.logger.LoggingPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.profiler.ProfilerDebugPanel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flask_debugtoolbar.panels.config_vars.ConfigVarsDebugPanel&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>


<p>Inicialize a extensão no arquivo <strong>news_app.py</strong></p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">flask_debugtoolbar</span> <span class="kn">import</span> <span class="n">DebugToolbarExtension</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
   <span class="o">...</span>
    <span class="n">DebugToolbarExtension</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Agora execute o projeto <code>python run.py</code> e navegue pelo site e pelo admin e analise os painéis do Flask-DebugToolbar que aparecerão na lateral direita.</p>
<figure>
<img src="/images/rochacbruno/debug_toolbar.png" alt="debug_toolbar" >
</figure>

<p>Note que temos vários painéis de DEBUG incluindo o painel MongoDB exibindo o tempo consumido para o acesso ao banco de dados, clicando neste botão da toolbar você poderá visualizar as queries que foram feitas ao MongoDB.</p>
<p>E também é interessante analisar o botão <strong>Profiler</strong> que exibe e o consumo de memória e CPU em cada parte de nosso app.</p>
<figure>
<img src="/images/rochacbruno/profiler.png" alt="profiler" >
</figure>

<p>No nosso caso como estamos em ambiente de desenvolvimento e com apenas um usuário fazendo requests os números serão insignificantes, porém basta colocar em produção e ter um <strong>slashdot effect</strong> que as coisas começarão a complicar.</p>
<p>Portanto vamos utilizar o <strong>Flask-Cache</strong> para minimizar o acesso ao MongoDB.</p>
<p>O Flask-Cache possui integração com alguns sistemas de cache e são eles:</p>
<p>Built-in cache types:</p>
<ul>
<li>null: NullCache (default)</li>
<li>simple: SimpleCache</li>
<li>memcached: MemcachedCache (pylibmc or memcache required)</li>
<li>gaememcached: GAEMemcachedCache</li>
<li>redis: RedisCache (Werkzeug 0.7 required)</li>
<li>filesystem: FileSystemCache</li>
<li>saslmemcached: SASLMemcachedCache (pylibmc required)</li>
</ul>
<blockquote>
<p>NOTE: O mais recomendado é o uso de <strong>Redis</strong> ou <strong>memcached</strong> mas como isso exige a instalação de libs adicionais utilizaremos o <strong>FileSystemCache</strong> em nosso exemplo, porém o uso de cache em file system pode ser até mais lento que o acesso direto ao banco, portanto vamos utiliza-lo somente como exemplo.</p>
</blockquote>
<p>Crie um arquivo <strong>cache.py</strong> na raiz do projeto:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;CACHE_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;filesystem&#39;</span><span class="p">,</span> <span class="s1">&#39;CACHE_DIR&#39;</span><span class="p">:</span> <span class="s1">&#39;/tmp&#39;</span><span class="p">})</span>
</pre></div>


<p>Vamos inicializar a extensão da mesma forma que fizemos com as outras e neste ponto nosso arquivo <strong>news_app.py</strong> deverá estar assim:</p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">flask_security</span> <span class="kn">import</span> <span class="n">Security</span><span class="p">,</span> <span class="n">MongoEngineUserDatastore</span>
<span class="kn">from</span> <span class="nn">flask_debugtoolbar</span> <span class="kn">import</span> <span class="n">DebugToolbarExtension</span>

<span class="kn">from</span> <span class="nn">.admin</span> <span class="kn">import</span> <span class="n">configure_admin</span>
<span class="kn">from</span> <span class="nn">.blueprints.noticias</span> <span class="kn">import</span> <span class="n">noticias_blueprint</span>
<span class="kn">from</span> <span class="nn">.db</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.security_models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>
<span class="kn">from</span> <span class="nn">.cache</span> <span class="kn">import</span> <span class="n">cache</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">instance_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_instance&quot;</span> <span class="o">%</span> <span class="n">mode</span>
    <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s2">&quot;wtf&quot;</span><span class="p">,</span>
                <span class="n">instance_path</span><span class="o">=</span><span class="n">instance_path</span><span class="p">,</span>
                <span class="n">instance_relative_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s1">&#39;wtf.default_settings&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s1">&#39;config.cfg&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PROJECT_ROOT&#39;</span><span class="p">),</span>
        <span class="n">app</span><span class="o">.</span><span class="n">instance_path</span><span class="p">,</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MEDIA_FOLDER&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">noticias_blueprint</span><span class="p">)</span>

    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">Security</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">datastore</span><span class="o">=</span><span class="n">MongoEngineUserDatastore</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="p">))</span>
    <span class="n">configure_admin</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">DebugToolbarExtension</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>


<p>Pronto, agora podemos começar a utilizar o cache nas views e templates.</p>
<blockquote>
<p>NOTE: Escrevi um artigo explicando o Flask-Cache com mais detalhes que está disponível <a href="http://brunorocha.org/python/flask/usando-o-flask-cache.html">em meu blog</a></p>
</blockquote>
<p>Vamos colocar cache nas views de acesso ao MongoDB importaremos o cache que criamos no arquivo <strong>cache.py</strong> e utilizaremos diretamente ou como forma de decorator.</p>
<p><strong>blueprints/noticias.py</strong></p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kn">from</span> <span class="nn">..cache</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="o">...</span>
</pre></div>


<p>Agora vamos utilizar o cache como decorator para cachear a view <strong>index</strong> durante 5 minutos utilizando <code>@cache.cached(timeout=300)</code> para decorar a view.</p>
<div class="highlight"><pre><span></span><span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="nd">@cache</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">todas_as_noticias</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
                           <span class="n">noticias</span><span class="o">=</span><span class="n">todas_as_noticias</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Todas as notícias&quot;</span><span class="p">)</span>
</pre></div>


<p>Agora acesse <a href="http://localhost:5000">localhost:5000</a> e repare que no primeiro acesso o MongoDB será acessado mas quando der refresh (f5) agora o acesso não será mais feito durante 5 minutos.</p>
<figure>
<img src="/images/rochacbruno/cached.png" alt="cached" >
</figure>

<p>Uma outra maneira de cachear é chamando o cache diretamente, vamos fazer isso na view <strong>noticia</strong> usando <strong>cache.get</strong> e <strong>cache.set</strong></p>
<div class="highlight"><pre><span></span><span class="nd">@noticias_blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/noticia/&lt;noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">):</span>
    <span class="n">noticia_cacheada</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noticia_cacheada</span><span class="p">:</span>
        <span class="n">noticia</span> <span class="o">=</span> <span class="n">noticia_cacheada</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noticia</span> <span class="o">=</span> <span class="n">Noticia</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">,</span> <span class="n">noticia</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;noticia.html&#39;</span><span class="p">,</span> <span class="n">noticia</span><span class="o">=</span><span class="n">noticia</span><span class="p">)</span>
</pre></div>


<p>Além das dessas duas maneiras também é possível cachear blocos de template e memoizar funções que recebem argumentos.</p>
<blockquote>
<p>BEWARE: Utilizar cache e controle de acesso é algo que deve ser feito com cuidado em nosso exemplo se um usuário autenticado acessar uma notícia com acesso controlado provavelmente o cache irá armazenar esta versão e todos os outros usuários terão acesso. Portanto se este for o seu caso, utilize o nome do usuário ou grupo como chave do cache.</p>
</blockquote>
<p>Se quiser saber mais detalhes sobre o Flask-Cache consulte a postagem que fiz em meu <a href="http://brunorocha.org/python/flask/usando-o-flask-cache.html">blog</a> e a <a href="https://pythonhosted.org/Flask-Cache/">documentação oficial</a>.</p>
<blockquote>
<p>O diff com as alterações realizadas com o Flask-Cache encontra-se em <a href="https://github.com/rochacbruno/wtf/commit/27bacd25a788ffc041de332403a2426cd199b828">27bacd25a788ffc041de332403a2426cd199b828</a></p>
</blockquote>
<p>Algumas outras extensões recomendadas que não foram abordadas neste artigo</p>
<ul>
<li><a href="https://github.com/rochacbruno/flasgger">Flasgger</a> Para criar APIs com documentaçãi via Swagger UI</li>
<li><a href="http://github.com/rochacbruno/Flask-GoogleMaps">Flask Google Maps</a> Para inserir mapas facilmente em apps Flask</li>
<li><a href="https://github.com/rochacbruno/dynaconf">Flask Dynaconf</a> Para configurações dinâmicas</li>
<li>[Flask Email] Para avisar os autores que tem novo comentário</li>
<li>[Flask Queue/Celery] Pare enviar o email assincronamente e não bloquear o request</li>
<li>[Flask Classy] Um jeito fácil de criar API REST e Views</li>
<li>[Flask Oauth e OauthLib] Login com o Feicibuque e tuinter</li>
</ul>
<blockquote>
<p>A versão final do app está no <a href="https://github.com/rochacbruno/wtf/tree/extended">github</a></p>
</blockquote>
<hr>

<blockquote>
<p><strong>END:</strong> Sim chegamos ao fim desta terceira parte da série <strong>W</strong>hat <strong>T</strong>he <strong>F</strong>lask. Eu espero que você tenha aproveitado as dicas aqui mencionadas. Nas próximas 2 partes iremos desenvolver nossas próprias extensões e blueprints e também questṍes relacionados a deploy de aplicativos Flask. Acompanhe o PythonClub, o meu <a href="http://brunorocha.org">site</a> e meu <a href="http://twitter.com/rochacbruno">twitter</a> para ficar sabendo quando a próxima parte for publicada.</p>
</blockquote>
<hr />

<blockquote>
<p><strong>PUBLICIDADE:</strong> Iniciarei um curso online de Python e Flask, para iniciantes abordando com muito mais detalhes e exemplos práticos os temas desta série de artigos e muitas outras coisas envolvendo Python e Flask, o curso será oferecido no CursoDePython.com.br, ainda não tenho detalhes especificos sobre o valor do curso, mas garanto que será um preço justo e acessível. Caso você tenha interesse por favor preencha este <a href="https://docs.google.com/forms/d/1qWx4pzNVSPQmxsLgYBjTve6b_gGKfKLMSkPebvpMJwg/viewform?usp=send_form">formulário</a> pois dependendo da quantidade de pessoas interessadas o curso sairá mais rapidamente.</p>
</blockquote>
<hr />

<blockquote>
<p><strong>PUBLICIDADE 2:</strong> Também estou escrevendo um livro de receitas <strong>Flask CookBook</strong> através da plataforma LeanPub, caso tenha interesse por favor preenche o formulário na <a href="https://leanpub.com/pythoneflask">página do livro</a></p>
</blockquote>
<hr />

<blockquote>
<p><strong>PUBLICIDADE 3:</strong> Inscreva-se no meu novo <a href="http://www.youtube.com/channel/UCKkjiNMtdyCOFE3-w7TB8xw?sub_confirmation=1">canal de tutoriais</a></p>
</blockquote>
<p>Muito obrigado e aguardo seu feedback com dúvidas, sugestões, correções etc na caixa de comentários abaixo.</p>
<p>Abraço! "Python é vida!"</p>

            <div class="licence">
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Licença Creative Commons"
                                                                                               style="border-width:0"
                                                                                               src="http://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png"/></a><br/><a
                    xmlns:dct="http://purl.org/dc/terms/" property="dct:title"
                    href="http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html">"What the Flask? Pt-3 Plug & Use - extensões essenciais para iniciar seu projeto"</a> de <a
                    xmlns:cc="http://creativecommons.org/ns#" href="http://pythonclub.com.br/author/bruno-cezar-rocha.html"
                    property="cc:attributionName" rel="cc:attributionURL">"Bruno Cezar Rocha"</a> está licenciado com uma Licença
                <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons -
                    Atribuição-NãoComercial-SemDerivações 4.0 Internacional</a>.
            </div>

            <div class="sharing">
                <!-- Facebook sharing -->
                <div id="fb-root"></div>
                <script>(function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&appId=1487080281503641&version=v2.0";
                fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));</script>
                <div class="fb-share-button" data-href="http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html" data-type="button_count"></div>

                <!-- Google+ sharing -->
                <div class="g-plus alinhar" data-action="share" data-annotation="bubble" data-href="http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html"></div>

                <!-- Twitter sharing -->
                <a href="https://twitter.com/share" class="twitter-share-button" data-lang="pt" style="margin-bottom: -4px !important;">Tweetar</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </div>

            <div class="hr"></div>
            <a href="#" class="go-top">Topo</a>
                <div class="comments">
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES: THIS CODE IS ONLY AN EXAMPLE * * */
                        var disqus_shortname = 'pythonclub'; // Required - Replace example with your forum shortname
                        var disqus_identifier = 'what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html';
                        var disqus_title = 'What the Flask? Pt-3 Plug & Use - extensões essenciais para iniciar seu projeto';
                        var disqus_url = 'http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html';
                    
                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
<footer class="footer">
    <p>&copy; PythonClub &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://pythonclub.com.br/theme/js/dynamic_random_articles.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
        $(window).load(function(){
          $("iframe").css("margin-bottom", "-6px")
          $("#twitter-widget-0").css("margin-bottom", "-5px");
          $("#twitter-widget-0").css("margin-left", "-1px");
        });
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/platform.js">
      {lang: 'pt-BR'}
    </script>

    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });

        $(function(){
            show_random_articles($('#random-articles'), [{"url": "http://pythonclub.com.br/encapsulamento-da-logica-do-algoritmo.html", "title": "Encapsulamento da l\u00f3gica do algoritmo"}, {"url": "http://pythonclub.com.br/fazendo-backup-do-banco-de-dados-no-django.html", "title": "Fazendo backup do banco de dados no Django"}, {"url": "http://pythonclub.com.br/django-ci-github-actions.html", "title": "Criando um CI de uma aplica\u00e7\u00e3o Django usando Github Actions"}, {"url": "http://pythonclub.com.br/crie_dict-a-partir-de-outros-dicts.html", "title": "Criando dicts a partir de outros dicts"}, {"url": "http://pythonclub.com.br/tutorial-django-2.html", "title": "Tutorial Django 2.2"}, {"url": "http://pythonclub.com.br/algoritmos-ordenacao.html", "title": "Algoritmos de Ordena\u00e7\u00e3o"}, {"url": "http://pythonclub.com.br/trabalhando-com-operadores-ternarios.html", "title": "Trabalhando com operadores tern\u00e1rios"}, {"url": "http://pythonclub.com.br/upload-de-arquivos-com-socket-e-struct.html", "title": "Upload de Arquivos com Socket e Struct"}, {"url": "http://pythonclub.com.br/monitorando-ips-duplicados-na-rede.html", "title": "Monitorando Ips Duplicados na Rede"}, {"url": "http://pythonclub.com.br/django-rest-framework-class-based-views.html", "title": "Django Rest Framework - #3 Class Based Views"}, {"url": "http://pythonclub.com.br/django-rest-framework-requests-responses.html", "title": "Django Rest Framework - #2 Requests and Responses"}, {"url": "http://pythonclub.com.br/progrmacao-funcional-com-python-2.html", "title": "Programa\u00e7\u00e3o funcional com Python #2 - Iteraveis e iteradores"}, {"url": "http://pythonclub.com.br/progrmacao-funcional-com-python-1.html", "title": "Programa\u00e7\u00e3o funcional com Python #1 - Fun\u00e7\u00f5es"}, {"url": "http://pythonclub.com.br/progrmacao-funcional-com-python-0.html", "title": "Programa\u00e7\u00e3o funcional com Python #0 - Saindo da zona de conforto"}, {"url": "http://pythonclub.com.br/peewee-um-orm-python-minimalista.html", "title": "Peewee - Um ORM Python minimalista"}, {"url": "http://pythonclub.com.br/what-the-flask-pt-4-extensoes-para-o-flask.html", "title": "What the Flask? pt 4 - Extens\u00f5es para o Flask"}, {"url": "http://pythonclub.com.br/configurando-python-3.5-openshift-flask-gunicorn.html", "title": "Configurando OpenShift com Python 3.5 + Flask + Gunicorn"}, {"url": "http://pythonclub.com.br/instalando-o-python-vers\u00e3o-3.7.0-alpha-1-no-ubuntu-16.04.md.html", "title": "Instalando o Python vers\u00e3o 3.7.0 alpha 1 no Ubuntu 16.04"}, {"url": "http://pythonclub.com.br/abrangencia-de-listas-e-dicionarios-com-python.html", "title": "Abrang\u00eancia de Listas e Dicion\u00e1rios"}, {"url": "http://pythonclub.com.br/debugging-logging.html", "title": "Debugging - logging"}, {"url": "http://pythonclub.com.br/deploy-rapido-simples-com-dokku.html", "title": "Deploy r\u00e1pido e simples com Dokku"}, {"url": "http://pythonclub.com.br/bot-telegram-mais-web-scraping-parte-1.html", "title": "Bot telegram mais web scraping - parte 1"}, {"url": "http://pythonclub.com.br/como-distribuir-sua-aplicacao-python-com-pypi.html", "title": "Como distribuir sua aplica\u00e7\u00e3o Python com PyPI"}, {"url": "http://pythonclub.com.br/python-webassets-elm.html", "title": "Python webassets & Elm"}, {"url": "http://pythonclub.com.br/curso-asyncio-aula1.html", "title": "Curso Python asyncio: Aula 01 - Iterators e Generators"}, {"url": "http://pythonclub.com.br/curso-asyncio-aula00.html", "title": "Curso Python asyncio: Aula 00 - Introdu\u00e7\u00e3o ao m\u00f3dulo asyncio"}, {"url": "http://pythonclub.com.br/gerando-relatorios-de-testes-com-coveralls.html", "title": "Relat\u00f3rios de testes com Coveralls"}, {"url": "http://pythonclub.com.br/python-com-unittest-travis-ci-coveralls-e-landscape-parte-4-de-4.html", "title": "Python com Unittest, Travis CI, Coveralls e Landscape (Parte 4 de 4)"}, {"url": "http://pythonclub.com.br/python-com-unittest-travis-ci-coveralls-e-landscape-parte-3-de-4.html", "title": "Python com Unittest, Travis CI, Coveralls e Landscape (Parte 3 de 4)"}, {"url": "http://pythonclub.com.br/python-com-unittest-travis-ci-coveralls-e-landscape-parte-2-de-4.html", "title": "Python com Unittest, Travis CI, Coveralls e Landscape (Parte 2 de 4)"}, {"url": "http://pythonclub.com.br/python-com-unittest-travis-ci-coveralls-e-landscape-parte-1-de-4.html", "title": "Python com Unittest, Travis CI, Coveralls e Landscape (Parte 1 de 4)"}, {"url": "http://pythonclub.com.br/github-pages-com-pelican-e-travis-ci.html", "title": "GitHub Pages com Pelican e Travis-CI"}, {"url": "http://pythonclub.com.br/sites-estaticos-com-lektor.html", "title": "Sites Est\u00e1ticos com Lektor"}, {"url": "http://pythonclub.com.br/django-rest-framework-serialization.html", "title": "Django Rest Framework Serialization"}, {"url": "http://pythonclub.com.br/explicit-is-better-than-implicit.html", "title": "Explicit is better than implicit"}, {"url": "http://pythonclub.com.br/tdd-com-python-e-flask.html", "title": "TDD com Python e Flask"}, {"url": "http://pythonclub.com.br/upload-de-arquivos-no-django-entendendo-os-modos-de-leitura.html", "title": "Upload de arquivos no Django: entendendo os modos de leitura"}, {"url": "http://pythonclub.com.br/python-generators.html", "title": "Python Generators"}, {"url": "http://pythonclub.com.br/paralelismo-em-python-usando-concurrent.futures.html", "title": "Paralelismo em Python usando concurrent.futures"}, {"url": "http://pythonclub.com.br/salvando-grafico-github-python-selenium.html", "title": "Salvando gr\u00e1fico de contribui\u00e7\u00f5es do Github com Python e Selenium"}, {"url": "http://pythonclub.com.br/como-encontrar-solucoes-python.html", "title": "Como encontrar solu\u00e7\u00f5es para seus problemas com Python"}, {"url": "http://pythonclub.com.br/criando-novos-comandos-no-django-admin.html", "title": "Criando novos comandos no django-admin"}, {"url": "http://pythonclub.com.br/extraindo-texto-de-imagens-com-python.html", "title": "Extraindo Texto de Imagens com Python"}, {"url": "http://pythonclub.com.br/django-rest-framework-quickstart.html", "title": "Django Rest Framework Quickstart"}, {"url": "http://pythonclub.com.br/material-do-tutorial-web-scraping-na-nuvem.html", "title": "Web Scraping na Nuvem com Scrapy"}, {"url": "http://pythonclub.com.br/class-based-views-django.html", "title": "Class Based Views no Django"}, {"url": "http://pythonclub.com.br/django-na-pratica-aula-01.html", "title": "Django na pr\u00e1tica - Hello World"}, {"url": "http://pythonclub.com.br/what-the-flask-pt-3-plug-use-extensoes-essenciais-para-iniciar-seu-projeto.html", "title": "What the Flask? Pt-3 Plug & Use - extens\u00f5es essenciais para iniciar seu projeto"}, {"url": "http://pythonclub.com.br/raspando-a-web-com-python-parte-1.html", "title": "Raspando a Web com Python: Introdu\u00e7\u00e3o"}, {"url": "http://pythonclub.com.br/instalando-pycharm-ubuntu.html", "title": "Instalando o PyCharm no Ubuntu (e irm\u00e3os)"}, {"url": "http://pythonclub.com.br/a-armadilha-dos-argumentos-com-valores-padrao.html", "title": "A armadilha dos argumentos com valores padr\u00e3o"}, {"url": "http://pythonclub.com.br/desenvolvendo-para-google-app-engine-com-tekton.html", "title": "Cria\u00e7\u00e3o de aplica\u00e7\u00f5es no Google App Engine com o Tekton"}, {"url": "http://pythonclub.com.br/django-introducao-queries.html", "title": "Como otimizar suas consultas no Django - De N a 1 em 20 minutos"}, {"url": "http://pythonclub.com.br/django-overview-10-minutos.html", "title": "Django - 3 anos em 10 minutos"}, {"url": "http://pythonclub.com.br/configurando-ambiente-django-com-apache-e-mod-wsgi.html", "title": "Configurando ambiente Django com Apache e mod_wsgi"}, {"url": "http://pythonclub.com.br/tuplas-mutantes-em-python.html", "title": "Tuplas mutantes em Python"}, {"url": "http://pythonclub.com.br/postgresql-e-django.html", "title": "PostgreSql e Django - parte 3"}, {"url": "http://pythonclub.com.br/postgresql-e-python3.html", "title": "PostgreSql e Python3 - parte 2"}, {"url": "http://pythonclub.com.br/microframework-contra-baterias-incluidas.html", "title": "Microframework contra &quot;Baterias Inclu\u00eddas&quot;"}, {"url": "http://pythonclub.com.br/debugging-em-python-sem-ide.html", "title": "Debugging em python (sem IDE)"}, {"url": "http://pythonclub.com.br/tutorial-postgresql.html", "title": "Tutorial PostgreSql - parte 1"}, {"url": "http://pythonclub.com.br/conteinerizando-suas-aplicacoes-django-com-docker-e-fig.html", "title": "Conteinerizando suas aplica\u00e7\u00f5es django com docker e fig"}, {"url": "http://pythonclub.com.br/publicando-seu-hello-world-no-heroku.html", "title": "Publicando seu Hello World no Heroku"}, {"url": "http://pythonclub.com.br/entrevista-henrique-bastos.html", "title": "Entrevista com Henrique Bastos"}, {"url": "http://pythonclub.com.br/testes-de-carga-com-o-locust.html", "title": "Testes de carga com o Locust"}, {"url": "http://pythonclub.com.br/tutorial-django-17.html", "title": "Tutorial Django 1.7"}, {"url": "http://pythonclub.com.br/integrando-django-com-cloudinary.html", "title": "Integrando o Django com Cloudinary"}, {"url": "http://pythonclub.com.br/bottle-framework-full-stack-sem-django.html", "title": "Bottle Framework full stack sem Django"}, {"url": "http://pythonclub.com.br/desenvolvendo-com-bottle-parte-1.html", "title": "Desenvolvendo com Bottle - Parte 1"}, {"url": "http://pythonclub.com.br/gerenciando-banco-dados-sqlite3-python-parte2.html", "title": "Gerenciando banco de dados SQLite3 com Python - Parte 2"}, {"url": "http://pythonclub.com.br/solucao-quase-definitiva-para-permissoes-em-projetos-django.html", "title": "Solu\u00e7\u00e3o (quase) definitiva para permiss\u00f5es em projetos Django"}, {"url": "http://pythonclub.com.br/gerenciando-assets-com-django-pipeline.html", "title": "Gerenciando assets com django-pipeline"}, {"url": "http://pythonclub.com.br/deploy-app-django-openshift.html", "title": "Deploy App Django no Openshift"}, {"url": "http://pythonclub.com.br/criando-sites-estaticos-com-pelican.html", "title": "Criando sites est\u00e1ticos com Pelican Framework"}, {"url": "http://pythonclub.com.br/selenium-parte-4.html", "title": "Selenium - O que voc\u00ea deveria saber - Parte 4"}, {"url": "http://pythonclub.com.br/configurando-um-servidor-de-producao-para-aplicacoes-python.html", "title": "Configurando um servidor de produ\u00e7\u00e3o para aplica\u00e7\u00f5es Python"}, {"url": "http://pythonclub.com.br/what-the-flask-pt-2-flask-patterns-boas-praticas-na-estrutura-de-aplicacoes-flask.html", "title": "What the Flask? Pt-2 Flask Patterns - boas pr\u00e1ticas na estrutura de aplica\u00e7\u00f5es Flask"}, {"url": "http://pythonclub.com.br/gerenciando-banco-dados-sqlite3-python-parte1.html", "title": "Gerenciando banco de dados SQLite3 com Python - Parte 1"}, {"url": "http://pythonclub.com.br/introducao-classes-metodos-python-basico.html", "title": "Introdu\u00e7\u00e3o a Classes e M\u00e9todos em Python (b\u00e1sico)"}, {"url": "http://pythonclub.com.br/pyftpdlib-criando-um-servidor-ftp-simples-com-python.html", "title": "pyftpdlib - Criando um servidor FTP simples com python"}, {"url": "http://pythonclub.com.br/usando-redis-cache-django.html", "title": "Usando Redis para cache e sess\u00e3o do Django"}, {"url": "http://pythonclub.com.br/aprendendo-e-ensinando-python.html", "title": "Aprendendo e Ensinando Python"}, {"url": "http://pythonclub.com.br/selenium-parte-3.html", "title": "Selenium - O que voc\u00ea deveria saber - Parte 3"}, {"url": "http://pythonclub.com.br/what-the-flask-pt-1-introducao-ao-desenvolvimento-web-com-python.html", "title": "What the Flask? Pt-1 Introdu\u00e7\u00e3o ao desenvolvimento web com Python"}, {"url": "http://pythonclub.com.br/selenium-parte-2.html", "title": "Selenium - O que voc\u00ea deveria saber - Parte 2"}, {"url": "http://pythonclub.com.br/guia-rapido-comandos-sqlite3.html", "title": "Guia r\u00e1pido de comandos SQLite3"}, {"url": "http://pythonclub.com.br/editando-o-admin-do-django.html", "title": "Editando o Admin do Django"}, {"url": "http://pythonclub.com.br/instalacao-python-django-windows.html", "title": "Instalando e Configurando o Python e Django no Windows"}, {"url": "http://pythonclub.com.br/criar-site-com-form-lista-30-min.html", "title": "Como criar um site com formul\u00e1rio e lista em 30 minutos?"}, {"url": "http://pythonclub.com.br/principais-duvidas-de-quem-quer-aprender-django.html", "title": "Principais d\u00favidas de quem quer aprender Django"}, {"url": "http://pythonclub.com.br/parseando-sites-com-beautifulsoup.html", "title": "Exemplo de como &quot;Parsear&quot; Sites com BeautifulSoup"}, {"url": "http://pythonclub.com.br/deploy-com-django-fagungis.html", "title": "Publica\u00e7\u00e3o de projetos com o Django-Fagungis"}, {"url": "http://pythonclub.com.br/como-fazer-fork-clone-push-pull-request-no-github.html", "title": "Como fazer fork, clone, push pull-request no Github"}, {"url": "http://pythonclub.com.br/primeiro-projeto-django-no-linux-com-sublime.html", "title": "Seu primeiro projeto Django com Sublime Text no Linux"}, {"url": "http://pythonclub.com.br/introducao-a-testes-funcionais-com-selenium-e-python.html", "title": "Introdu\u00e7\u00e3o a testes funcionais com Selenium e Python"}, {"url": "http://pythonclub.com.br/selenium-parte-1.html", "title": "Selenium - O que voc\u00ea deveria saber - Parte 1"}, {"url": "http://pythonclub.com.br/5-django-apps-que-nao-vivo-se.html", "title": "5 Django Apps que n\u00e3o vivo sem"}, {"url": "http://pythonclub.com.br/sobre-o-six-e-como-ele-ajuda-a-escrever-codigo-compativel-com-python-2-e-3.html", "title": "Sobre o six e como ele ajuda a escrever c\u00f3digo compat\u00edvel com python 2 e 3"}, {"url": "http://pythonclub.com.br/como_colaborar_com_projetos_open_source.html", "title": "Como colaborar na tradu\u00e7\u00e3o do Djangobook sem conhecer programa\u00e7\u00e3o"}], 10);
        });
        
    </script>
        <!-- spot_im -->
        <!--    <div id="spot-im-root"></div> -->
        <!--    <script type="text/javascript">!function(t,o,p){function e(){var t=o.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==o.location.protocol?"https":"http")+":"+p,o.body.appendChild(t)}t.spotId="3de816246c80a51757bb01c5b8c95cda",t.spotName="",t.allowDesktop=!0,t.allowMobile=!1,t.containerId="spot-im-root",e()}(window.SPOTIM={},document,"//www.spot.im/embed/scripts/launcher.js");</script> -->
        <!-- end spot_im -->
   
            <script>
              ((window.gitter = {}).chat = {}).options = {
                    room: 'pythonclub/pythonclub.github.io'
              };
            </script>
            <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
   
</body>
</html>